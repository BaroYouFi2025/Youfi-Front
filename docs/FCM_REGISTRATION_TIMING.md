# FCM 토큰 등록 요청 시점

이 문서는 FCM 토큰이 언제 백엔드 서버에 등록되는지 설명합니다.

---

## 1. 로그인 성공 시 (자동)

**파일**: `screens/Auth/login.tsx`

**시점**: 사용자가 로그인에 성공한 직후

**조건**:
- 알림 권한이 허용되어 있어야 함 (`AUTHORIZED` 또는 `PROVISIONAL`)
- 알림 권한이 아직 결정되지 않았으면 (`NOT_DETERMINED`) 권한 요청 팝업 표시
- 알림 권한이 거부되어 있으면 (`DENIED`) 토큰 등록을 건너뜀

**코드 위치**:
```typescript
// login.tsx:92
await registerDevice(token, accessToken);
console.log('FCM 토큰 등록 완료');
```

**로그 메시지**:
- 성공: `FCM 토큰 등록 완료`
- 실패: `FCM 토큰 등록 실패: ...`
- 권한 거부: `알림 권한이 거부되어 FCM 토큰 등록을 건너뜁니다.`

---

## 2. 앱 초기 로드 시 (자동)

**파일**: `app/_layout.tsx`

**시점**: 앱이 처음 실행될 때 (RootLayout 컴포넌트가 마운트될 때)

**조건**:
- 사용자가 이미 로그인되어 있어야 함 (`accessToken` 존재)
- 알림 권한이 허용되어 있어야 함

**코드 위치**:
```typescript
// _layout.tsx:77
// 초기 로드 시에도 확인
checkAndRegisterFCMToken();
```

**로그 메시지**:
- 성공: `FCM 토큰 등록 완료 (앱 활성화 시)`
- 실패: `FCM 토큰 등록 실패: ...`

---

## 3. 앱이 포그라운드로 돌아올 때 (자동)

**파일**: `app/_layout.tsx`

**시점**: 앱이 백그라운드에서 포그라운드로 전환될 때

**조건**:
- 사용자가 이미 로그인되어 있어야 함 (`accessToken` 존재)
- 알림 권한이 허용되어 있어야 함
- 앱 상태가 `active`로 변경될 때

**코드 위치**:
```typescript
// _layout.tsx:69-73
const appStateSubscription = AppState.addEventListener('change', (nextAppState) => {
  if (nextAppState === 'active') {
    checkAndRegisterFCMToken();
  }
});
```

**예시 시나리오**:
- 사용자가 다른 앱으로 전환했다가 다시 돌아올 때
- 사용자가 홈 화면으로 나갔다가 다시 앱으로 돌아올 때
- 사용자가 알림을 클릭하여 앱을 열 때

**로그 메시지**:
- 성공: `FCM 토큰 등록 완료 (앱 활성화 시)`
- 실패: `FCM 토큰 등록 실패: ...`

---

## 4. 사용자가 수동으로 버튼 클릭 시 (수동)

**파일**: `screens/Home/home.tsx`

**시점**: 홈 화면에서 "FCM 기기 등록하기" 버튼을 클릭할 때

**조건**:
- Firebase가 사용 가능해야 함 (네이티브 빌드)
- 알림 권한이 허용되어 있어야 함

**코드 위치**:
```typescript
// home.tsx:140
const response = await registerDevice(token);
```

**주의사항**:
- 이 버튼은 `accessToken`을 전달하지 않습니다 (버그일 수 있음)
- 개발/테스트 목적으로 사용됩니다

**로그 메시지**:
- 성공: `Device registered: ...`
- 실패: `Error registering device: ...`

---

## 요약

| 시점 | 파일 | 자동/수동 | 조건 |
|------|------|----------|------|
| 로그인 성공 시 | `login.tsx` | 자동 | 알림 권한 허용 |
| 앱 초기 로드 시 | `_layout.tsx` | 자동 | 로그인 + 알림 권한 허용 |
| 포그라운드 복귀 시 | `_layout.tsx` | 자동 | 로그인 + 알림 권한 허용 |
| 버튼 클릭 시 | `home.tsx` | 수동 | Firebase 사용 가능 |

---

## 중요 사항

1. **알림 권한이 필수**: 모든 자동 등록은 알림 권한이 허용되어 있어야 합니다.
2. **로그인 상태 확인**: `_layout.tsx`의 자동 등록은 로그인 상태를 확인합니다.
3. **중복 등록**: 같은 토큰을 여러 번 등록해도 문제없습니다 (백엔드에서 업데이트 처리).
4. **에러 처리**: 모든 등록 시도는 에러를 잡아서 로그인/앱 실행을 방해하지 않습니다.

---

## 디버깅 팁

콘솔에서 다음 로그를 확인하세요:

- `🔍 FCM 토큰 등록 요청:` - 등록 시도 시작
- `✅ FCM 토큰 등록 성공:` - 등록 성공
- `❌ FCM 토큰 등록 실패:` - 등록 실패 (상세 정보 포함)
- `FCM 토큰 등록 완료` - 로그인 시 성공
- `FCM 토큰 등록 완료 (앱 활성화 시)` - 앱 활성화 시 성공

