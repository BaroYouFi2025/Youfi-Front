# FCM 토큰 발급 및 전달 흐름

## 전체 흐름도

```
1. 앱 실행 (클라이언트)
   ↓
2. Firebase SDK 호출: messaging().getToken()
   ↓
3. Firebase 서버에 토큰 요청
   ↓
4. Firebase 서버가 FCM 토큰 발급
   ↓
5. 앱이 FCM 토큰 수신 (콘솔에 출력)
   ↓
6. 앱이 백엔드 서버에 토큰 등록 (POST /device)
   ↓
7. 백엔드 서버가 토큰 저장 (DB에 저장)
   ↓
8. 나중에 알림 전송 시:
   백엔드 → Firebase 서버 → 앱
```

## 상세 설명

### 1. FCM 토큰 발급 (Firebase 서버 → 앱)

**발급 주체:** Firebase 서버
**수신 주체:** 앱 (클라이언트)

```javascript
// 앱에서 호출
const token = await messaging().getToken();
// Firebase 서버에서 직접 토큰을 받아옵니다
```

- Firebase 서버가 직접 앱에 토큰을 발급합니다
- 앱을 통해서만 받을 수 있습니다 (서버에서 직접 발급 불가)
- 각 디바이스마다 고유한 토큰이 발급됩니다

### 2. FCM 토큰 등록 (앱 → 백엔드 서버)

**전송 주체:** 앱 (클라이언트)
**수신 주체:** 백엔드 서버

```javascript
// 앱에서 백엔드로 전송
await registerDevice(token, accessToken);
// POST /device
// Body: { fcmToken: "..." }
```

- 앱이 받은 FCM 토큰을 백엔드 서버에 등록합니다
- 백엔드 서버는 이 토큰을 데이터베이스에 저장합니다
- 나중에 알림을 보낼 때 이 토큰을 사용합니다

### 3. 알림 전송 (백엔드 → Firebase → 앱)

**전송 주체:** 백엔드 서버
**중계:** Firebase 서버
**수신 주체:** 앱

```
백엔드 서버
  ↓ (FCM Admin SDK 사용)
Firebase 서버
  ↓ (FCM 서비스)
앱 (디바이스)
```

## 왜 이렇게 복잡한가?

1. **보안**: FCM 서버 키는 백엔드에만 있어야 합니다 (클라이언트 노출 금지)
2. **관리**: 백엔드에서 사용자별 토큰을 관리하고 알림을 전송합니다
3. **확장성**: 여러 디바이스, 여러 사용자에게 알림을 보낼 수 있습니다

## 요약

- **FCM 토큰 발급**: Firebase 서버 → 앱 (직접, 앱을 통해서만)
- **FCM 토큰 등록**: 앱 → 백엔드 서버 (앱이 백엔드에 전달)
- **알림 전송**: 백엔드 → Firebase → 앱

**결론**: FCM 토큰은 Firebase 서버에서 발급되지만, 앱을 통해서만 받을 수 있고, 그 후 앱이 백엔드 서버에 등록하는 구조입니다.

